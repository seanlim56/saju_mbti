import random
import zlib
from datetime import date

# ==========================================
# 1. 헬퍼 함수 (시드, 별점, 점수 계산)
# ==========================================

def _crc_seed(*parts) -> int:
    """결정론적 시드 생성 (하루 동안 같은 결과 보장)"""
    # None이 들어와도 안전하게 처리
    s = "|".join("" if p is None else str(p) for p in parts)
    return zlib.crc32(s.encode("utf-8"))


def _band(score: int) -> int:
    """점수대별 티어 구간 매핑"""
    for t in [100, 95, 90, 85, 80, 75, 70, 65, 60, 55, 50, 45, 40, 35, 30, 25, 20, 15, 10]:
        if score >= t:
            return t
    return 10


def _stars(score: int) -> str:
    """점수 → 별 개수 변환"""
    if score >= 100:
        return "⭐⭐⭐⭐⭐⭐"
    if score >= 90:
        return "⭐⭐⭐⭐⭐"
    if score >= 75:
        return "⭐⭐⭐⭐"
    if score >= 55:
        return "⭐⭐⭐"
    if score >= 35:
        return "⭐⭐"
    return "⭐"


# ==========================================
# 2. MZ 엠지 데이터 (티어, 십신, 액션 등)
# ==========================================

TIER_TITLES = {
    100: ["오늘의 주인공은 너", "도파민 풀충전! 인생샷 건지는 날", "숨만 쉬어도 갓생 등극"],
    95: ["폼 미쳤다(좋은 뜻)", "인싸력 만렙 찍음", "망설임? 그게 뭐죠?"],
    90: ["인생 하이라이트 구간", "운이 나를 따라다님", "뭘 해도 되는 날"],
    85: ["빌드업 끝, 이제 수확", "안전하게 떡상 중", "소소한 행운 적립 완료"],
    80: ["기본기만 해도 승리", "멘탈 방어력 최상", "꾸준함이 이기는 날"],
    75: ["뇌섹 모드 ON", "감각이 살아있네", "작은 선택, 큰 이득"],
    70: ["잠재력 터지는 중", "속도보다 방향이 맞음", "원석 발견의 날"],
    65: ["한 수 숨기고 이득 챙김", "타이밍 싸움 승리", "말보다 행동이 먹힘"],
    60: ["존버가 답이다", "무난한 게 베스트", "소소한 승리 챙기기"],
    55: ["컨디션 관리가 생명", "뇌절만 안 하면 평타", "작은 정리부터 시작"],
    50: ["안개 낀 날, 관찰 모드", "결정은 내일로 미루기", "리셋 버튼 누를 때"],
    45: ["말실수 주의보", "예민함 폭발 직전", "브레이크 밟으세요"],
    40: ["지갑 절대 지켜", "작은 실수 조심", "방어 운전 필수"],
    35: ["자존심보단 실속", "잠깐 멈춤이 필요해", "3초만 생각하고 말하기"],
    30: ["내공 쌓는 시간", "크게 벌리지 말기", "오늘은 수비 모드"],
    25: ["에너지 절전 모드", "일찍 귀가 추천", "마찰은 피하는 게 상책"],
    20: ["무리하면 바로 손해", "휴식이 최고의 개운", "디지털 디톡스 시급"],
    15: ["혼자만의 시간 필요", "거리두기가 답", "조용히 지나가자"],
    10: ["바닥 찍었으니 올라갈 일만", "대청소/정리로 액땜", "내일은 맑음"],
}

GOD_MZ = {
    "비견": {
        "tag": "자아/주도권",
        "hook": "오늘은 '나'가 기준",
        "buff": ["내 페이스대로 하면 다 이김", "자존심 세우면 오히려 인정받음"],
        "risk": ["'내가 맞아' 병 도지기 쉬움", "남의 말 끊으면 바로 손해"],
        "taboo": ["독단적 결정", "인정 욕구 폭발"],
        "action_pool": ["거울 보고 '나 좀 괜찮네' 3번 하기", "남 눈치 안 보고 내 루틴 지키기"],
    },
    "겁재": {
        "tag": "승부/경쟁",
        "hook": "승부사 본능 깨어남",
        "buff": ["경쟁자 있으면 능력치 2배", "한 방보다 '한 수'가 통함"],
        "risk": ["사람이랑 싸우면 100% 손해", "감정적으로 지르면 회수 불가"],
        "taboo": ["충동 내기/베팅", "홧김비용 지출"],
        "action_pool": ["경쟁은 '일'이랑만 하기", "지기 싫어서 무리하지 않기(10분 휴식)"],
    },
    "식신": {
        "tag": "생산/몰입",
        "hook": "결과물로 말하는 날",
        "buff": ["하나만 제대로 해도 판이 바뀜", "꾸준히 한 게 빛을 봄"],
        "risk": ["너무 파고들다 번아웃 옴", "완벽주의 버려야 성공"],
        "taboo": ["처음부터 100점 노리기", "정리 안 하고 새 판 벌리기"],
        "action_pool": ["결과물 '초안'이라도 저장하기", "70% 완성도에서 일단 제출/공유하기"],
    },
    "상관": {
        "tag": "표현/변화",
        "hook": "입 터지는 날(좋은 의미)",
        "buff": ["말 한마디로 상황 정리 가능", "고인 물 뒤집으면 돈 나옴"],
        "risk": ["팩폭 날리다 내가 다침", "논쟁 이겨봐야 남는 건 적"],
        "taboo": ["말로 다 이기려 들기", "남의 약점 건드리기"],
        "action_pool": ["할 말 메모장에 쓰고 10초 뒤에 보내기", "질문 먼저 하고 내 주장은 나중에"],
    },
    "편재": {
        "tag": "확장/큰물",
        "hook": "판 키우면 유리함",
        "buff": ["사람 만날수록 기회 생김", "현장에 답이 있음"],
        "risk": ["재미 찾다 돈만 씀", "벌려만 놓고 수습 못 함"],
        "taboo": ["기분파 지출", "즉흥 약속 잡기"],
        "action_pool": ["지출/약속은 '보류' 옵션 걸어두기", "새 아이디어 10분만 작게 테스트하기"],
    },
    "정재": {
        "tag": "안정/실속",
        "hook": "숫자가 내 편인 날",
        "buff": ["꼼꼼하게 챙기면 다 돈임", "작은 규칙이 멘탈 잡아줌"],
        "risk": ["너무 재다가 타이밍 놓침", "안전빵만 찾다 기회 날림"],
        "taboo": ["지나친 짠돌이 모드", "쓰면서 죄책감 갖기"],
        "action_pool": ["오늘 쓸 돈 딱 정해두고 맘 편히 쓰기", "가계부/잔고 딱 한 번만 확인하기"],
    },
    "편관": {
        "tag": "권위/압박",
        "hook": "카리스마 폭발",
        "buff": ["단호하게 나가면 다 따름", "위기 상황에서 영웅 됨"],
        "risk": ["센 척하다 몸살 남", "내가 다 짊어지려다 터짐"],
        "taboo": ["혼자 독박 쓰기", "아파도 참기"],
        "action_pool": ["30분 '멍때리기' 시간 강제로 넣기", "부당한 부탁 딱 잘라 거절하기"],
    },
    "정관": {
        "tag": "원칙/신용",
        "hook": "정석대로 하면 됨",
        "buff": ["기본만 지켜도 점수 따는 날", "신뢰가 무기가 됨"],
        "risk": ["융통성 없어서 꼰대 소리 들음", "절차 따지다 알맹이 놓침"],
        "taboo": ["남 지적질", "매뉴얼 타령"],
        "action_pool": ["약속/마감 시간 5분 전에 지키기", "중요한 건 기록(카톡/메일)으로 남기기"],
    },
    "편인": {
        "tag": "직관/아이디어",
        "hook": "촉이 오는 날",
        "buff": ["남들 못 보는 걸 봄", "정보를 엮으면 돈이 됨"],
        "risk": ["생각만 하다 날 샘", "의심병 도져서 기회 참"],
        "taboo": ["결정 무한 미루기", "방구석 시뮬레이션"],
        "action_pool": ["생각난 거 바로 5분만 실행해보기", "검색 그만하고 일단 저지르기"],
    },
    "정인": {
        "tag": "인기/수용",
        "hook": "사랑받는 날",
        "buff": ["가만있어도 도와줌", "내 편이 생기는 하루"],
        "risk": ["받는 거 당연하게 생각함", "게으름 피우다 살 찜"],
        "taboo": ["감사 인사 생략", "해줘 모드"],
        "action_pool": ["도움 준 사람한테 구체적으로 고맙다고 하기", "받은 칭찬 기록해두기"],
    },
}

FOCUS_KEYWORDS = {
    "일/성과": ["성과", "마감", "집중", "돌파"],
    "일/정리": ["정리", "비움", "체계", "우선순위"],
    "돈/기회": ["기회", "투자", "확장", "네트워크"],
    "돈/관리": ["절약", "예산", "방어", "점검"],
    "돈/방어": ["보안", "거절", "신중", "지킴"],
    "관계/연결": ["만남", "소통", "협력", "매력"],
    "관계/합의": ["조율", "약속", "존중", "경청"],
    "관계/거리": ["독립", "차단", "침묵", "냉정"],
    "회복/루틴": ["수면", "운동", "영양", "반복"],
    "회복/휴식": ["멍때리기", "산책", "치유", "여유"],
}

FOCUS_ACTIONS = {
    "일/성과": ["오늘 할 일 딱 1개만 '완료'하기", "45분 집중하고 15분 쉬기", "결론부터 말하는 연습하기"],
    "일/정리": ["바탕화면/책상 10분만 정리하기", "안 해도 되는 일 리스트에서 지우기", "내일 할 일 3개만 미리 적기"],
    "돈/기회": ["새로운 정보/뉴스 1개 찾아보기", "안부 묻고 싶던 사람에게 연락하기", "작은 아이디어 메모하기"],
    "돈/관리": ["구독 서비스 하나 점검하기", "오늘 지출 내역 한 번 훑어보기", "만원 아끼기 챌린지"],
    "돈/방어": ["충동구매 전 10분 고민하기", "돈 빌려달란 말 단호하게 거절", "지갑 집에 두고 산책하기"],
    "관계/연결": ["고마운 사람에게 기프티콘/톡 보내기", "대화할 때 폰 보지 않기", "먼저 웃으면서 인사하기"],
    "관계/합의": ["애매한 약속 확실하게 정하기", "서운한 거 담아두지 말고 좋게 말하기", "내 의견 1분 안에 정리해 말하기"],
    "관계/거리": ["불편한 톡방 알림 끄기", "싫은 건 싫다고 정중히 말하기", "혼자 점심 먹으며 쉬기"],
    "회복/루틴": ["물 3잔 마시기", "일어나자마자 이불 개기", "자기 전 스트레칭 5분"],
    "회복/휴식": ["좋아하는 음악 들으며 10분 멍때리기", "잠깐이라도 햇볕 쫴기", "오늘 나에게 '고생했다' 말해주기"],
}

# ==========================================
# 3. 메인 로직 (서브 십신 반영)
# ==========================================

def get_today_fortune(
    user_year,
    user_month,
    user_day,
    strongest_10,
    sub_10=None,              # ✅ 서브 십신 추가 (소름 포인트)
    mbti=None,
    strongest_element=None,
):
    """
    MZ 스타일 오늘의 운세 생성기 (최종 통합본)
    - sub_10 (서브 십신) 반영으로 디테일 강화
    """
    today = date.today()
    
    # 1. 결정론적 시드 생성 (입력값이 같으면 항상 같은 결과)
    seed_val = _crc_seed(
        today.strftime("%Y%m%d"),
        user_year, user_month, user_day,
        strongest_10, sub_10, mbti, strongest_element
    )
    rng = random.Random(seed_val)

    # 2. 점수 및 기본 정보 생성
    score = rng.randrange(10, 101, 5)
    band = _band(score)
    stars = _stars(score)
    tier = rng.choice(TIER_TITLES.get(band, ["오늘은 오늘이다"]))

    # 3. 십신 데이터 가져오기
    # 메인 십신
    strongest_10 = (strongest_10 or "").strip()
    if strongest_10 not in GOD_MZ:
        strongest_10 = "비견" # 기본값
    main_god = GOD_MZ[strongest_10]

    # 서브 십신 (메인과 다를 때만)
    sub_god = None
    sub_10 = (sub_10 or "").strip()
    if sub_10 and sub_10 in GOD_MZ and sub_10 != strongest_10:
        sub_god = GOD_MZ[sub_10]

    # 4. 점수대별 톤 & 포커스 설정
    if score >= 85:
        tone = "high"
        focus_pool = ["일/성과", "돈/기회", "관계/연결"]
    elif score >= 55:
        tone = "mid"
        focus_pool = ["일/정리", "돈/관리", "관계/합의", "회복/루틴"]
    else:
        tone = "low"
        focus_pool = ["회복/휴식", "돈/방어", "관계/거리", "일/정리"]

    focus = rng.choice(focus_pool)
    
    # [소름 포인트] 서브 십신이 있으면 가끔 포커스를 비틀어버림 (35% 확률)
    if sub_god and rng.random() < 0.35:
        # 원래 포커스 말고 다른 걸로 바꿈 (예: 돈 벌려다 인간관계 터짐 등)
        others = [f for f in focus_pool if f != focus]
        if others:
            focus = rng.choice(others)

    # 5. 코멘트 조립 (메인 + 서브)
    # (A) 메인 코멘트
    if tone == "high":
        main_msg = f"{main_god['hook']}! {focus} 쪽이 대박임. {rng.choice(main_god['buff'])}"
    elif tone == "mid":
        main_msg = f"{main_god['hook']}. {focus}만 챙겨도 이득. {rng.choice(main_god['buff'])}"
    else:
        main_msg = f"{main_god['hook']}... {focus} 무리하면 다침. {rng.choice(main_god['risk'])}"
    
    # 금지어 추가
    main_taboo = rng.choice(main_god.get("taboo", ["무리수"]))
    comment = f"{main_msg} (🚫금지: {main_taboo})"

    # (B) 서브(부캐) 코멘트 - 있으면 뒤에 붙임
    sub_taboo = None
    if sub_god:
        # 서브는 짧게 "숨은 변수" 느낌으로
        sub_msg_pool = sub_god['buff'] if tone != "low" else sub_god['risk']
        sub_msg = rng.choice(sub_msg_pool)
        
        # 서브 금지어도 뽑아둠 (나중에 쓸 수 있음)
        sub_taboo = rng.choice(sub_god.get("taboo", ["충동"]))
        
        # 코멘트에 합치기 (화면에서 한 줄로 보이거나 줄바꿈되도록)
        # 템플릿 필터 |linebreaksbr 있으면 줄바꿈 됨
        comment += f"\n👉 숨은 변수({sub_10}): {sub_msg}"

    # 6. 키워드 & 액션 뽑기
    keyword = rng.choice(FOCUS_KEYWORDS.get(focus, ["밸런스"]))
    
    # 액션 후보군 합치기 (포커스 공통 + 메인 십신 전용 + 서브 십신 전용)
    action_candidates = list(FOCUS_ACTIONS.get(focus, []))
    action_candidates += main_god.get("action_pool", [])
    if sub_god:
        action_candidates += sub_god.get("action_pool", [])
    
    # 중복 제거 후 랜덤 선택
    action_candidates = list(set(action_candidates))
    if not action_candidates:
        action = "오늘은 그냥 푹 쉬는 게 최고의 액션"
    else:
        action = rng.choice(action_candidates)

    return {
        "score": score,
        "stars": stars,
        "tier": tier,
        "keyword": keyword,
        "action": action,
        "comment": comment,
        # 아래는 템플릿에서 필요하면 갖다 쓰라고 넣어둠
        "focus": focus,
        "god_tag": main_god.get("tag", ""),
        "taboo": main_taboo,
        "subgod": sub_10,
        "sub_taboo": sub_taboo,
    }
