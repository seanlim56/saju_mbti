import random
import zlib

def _get_seed(elem, seed_key=None):
    """
    seed_key(사용자 고유 정보)가 있으면 고정된 시드값을 반환하고,
    없으면 None을 반환하여 완전 랜덤으로 작동하게 함.
    """
    if seed_key:
        # 문자열을 숫자로 변환 (CRC32 체크섬 사용)
        return zlib.crc32(str(seed_key).encode('utf-8'))
    return None

def get_location_recommendation(weakest_element, seed_key=None):
    """
    부족한 오행을 채워줄 힙한 공간 전략 (Ultimate Edition).
    weakest_element: '목', '화', '토', '금', '수'
    seed_key: 결과 고정을 위한 사용자 고유 키 (이름+생년월일 등)
    """
    
    # 데이터 풀: MZ 트렌드, 힐링, 도파민, 인사이트가 섞인 장소와 미션들
    data = {
        '목': {
            'direction': '동쪽 (성장의 기운)',
            'vibe': '생명력, 시작, 청량함, 리셋',
            'spot': [
                '성수동/연남동 플랜테리어 카페 🌿',
                '새벽 6시의 남산 산책로 🏃',
                '통창으로 햇살이 쏟아지는 도서관 📚',
                '독립 서점 (새로운 영감 얻기) 📖',
                '꽃시장 (생화 에너지 충전) 💐',
                '퇴근 후 동네 놀이터 벤치 (이어폰 빼고 소리 듣기) 👟',
                '반려식물 편집숍 (구경만 해도 운이 풀림) 🌿',
                '지하철 한 정거장 일찍 내려서 걷는 가로수길 🌳',
                '스탠딩 데스크 있는 코워킹 스페이스 (2시간 집중) 💼',
                '하늘이 뻥 뚫린 옥상 라운지 ☁️',
                '식물원/온실 (습한 흙냄새 맡기) 🌱',
                '한강공원 잔디밭 (노트북 없이 멍 때리기) 🍀',
            ],
            'desc': [
                '당신에겐 무기력을 뚫고 나올 **나무의 돌파력**이 필요합니다. 갇혀있지 말고 밖으로 나가세요.',
                '머리는 복잡한데 몸은 안 움직인다면, 지금 필요한 건 **설계가 아니라 산책 루틴**입니다.',
                '이 시기엔 카톡·브라우저보다 **햇빛·초록색**이 더 큰 인사이트를 줍니다.',
            ],
            'mission': [
                '오전 7시 전에 일어나서, 식물이 보이는 곳에서 오늘 할 일 3개만 적어보세요.',
                '카페 자리 잡기 전에, 주변을 10분만 돌며 **‘마음에 드는 초록색 3개’**를 찾아보세요.',
                '휴대폰 메모장이 아니라 **종이 노트**에 오늘 할 일 3가지 적고, 끝낼 때마다 줄을 쫙 그어보세요.',
                '퇴근 후 바로 집에 가지 말고, **나무 많은 길로 한 정거장만 더 걷기**.',
            ],
            'avoid': '먼지 쌓인 지하 창고나 창문 없는 방 (당신의 운을 말라 죽게 함) 🚫',
        },

        '화': {
            'direction': '남쪽 (열정의 정점)',
            'vibe': '화려함, 조명, 시선 집중, 도파민',
            'spot': [
                '부산 해운대/광안리 오션뷰 라운지 🔥',
                '화려한 조명의 강남역/이태원 펍 🍸',
                '한남동/청담동 명품 쇼룸 (눈호강) 👠',
                '공연장이나 페스티벌 현장 (떼창 가능) 🎸',
                '햇볕이 강하게 내리쬐는 루프탑 ☀️',
                '도심 한복판 코인노래방 (혼자 3곡 지르기) 🎤',
                '불꽃놀이·야간 드론쇼 같은 ‘빛 많은’ 행사장 🎆',
                '친구랑 편의점 앞 노가리 (라면+맥주 조합) 🍜',
                '오픈 마이크 공연장/코미디 클럽 🎭',
                '낯선 동네 포장마차 (사람 구경) 🍶',
                '버스 맨 뒷좌석 창가 (드라마 주인공 놀이) 🚌',
            ],
            'desc': [
                '차가운 현실을 녹여줄 **뜨거운 에너지**가 필요합니다. 숨지 말고 주인공이 되세요.',
                '요즘 당신의 에너지는 절약 모드입니다. 인생은 **배터리 5% 남았을 때 제일 재밌는 알림**이 와요.',
                '불안할수록 숨어버리기 쉽지만, 지금은 **‘내가 재밌는 사람’이라는 걸 확인할 배경**이 필요합니다.',
            ],
            'mission': [
                '가장 화려한 옷을 입고 핫플에서 셀카 한 장 건지세요. 붉은 조명이 포인트!',
                '오늘은 필터 빵빵 말고, **노메이크업+조명빨 사진 1장**만 인생샷으로 건져보세요.',
                '핫플에서 셀카 찍고, **나 자신한테만 보내는 DM**으로 ‘오늘 잘 버텼다’고 써보세요.',
                '집-회사-집 루트를 깨고, **불 켜진 거리에서 30분만 혼자 걷기**.',
            ],
            'avoid': '습하고 어두운 지하실이나 냉방이 너무 강한 곳 (열정 식음 주의) 🚫',
        },

        '토': {
            'direction': '중앙 (안정의 중심)',
            'vibe': '편안함, 클래식, 묵직함, 힐링',
            'spot': [
                '경주 황리단길/북촌 한옥마을 🏯',
                '맨발 걷기가 가능한 황토길 👣',
                '오래된 LP바나 고즈넉한 찻집 🍵',
                '도자기 공방이나 전시관 🏺',
                '캠핑장 (불멍 때리기 좋은 곳) ⛺',
                '동네 도서관 ‘구석진 자리’ (사람 없는 시간대) 📚',
                '동네 공원 벤치 (커피 다 마실 때까지 폰 금지) ☕',
                '대형 마트 식품 코너 (천천히 구경하기) 🛒',
                '이케아/가구 매장 (살고 싶은 집 상상하기) 🛋️',
                '호텔 로비나 라운지 (그냥 앉아서 쉬기) 🛎️',
                '바닥에 앉을 수 있는 좌식 카페 🧺',
            ],
            'desc': [
                '속도전에서 벗어나 **대지의 단단함**을 느껴야 할 때입니다. 중심을 잡으세요.',
                '비교와 경쟁이 과열되면, 토 기운은 **‘여기까지도 잘했다’고 멈춰주는 브레이크**가 됩니다.',
                '남들 스토리에서 내려와서, **내 발 밑이 단단한지부터 확인해야 하는 타이밍**입니다.',
            ],
            'mission': [
                '흙을 밟거나 도자기/가죽 같은 천연 소재를 만지며 마음을 차분히 가라앉히세요.',
                '오늘은 서랍 한 칸, 서랍장 전체 말고 **‘딱 한 칸만’** 정리해보세요. 인생도 그렇게 정리됩니다.',
                '앉을 자리를 고를 때, **등이 기댈 수 있는 자리**를 찾아보세요. 생각보다 큽니다.',
                '카페에 가면 노트북 말고 **종이 책/노트만 들고 가기**. 멀티태스킹 금지.',
            ],
            'avoid': '흔들리는 배 위나 너무 높은 고층 빌딩 전망대 (불안감 증폭) 🚫',
        },

        '금': {
            'direction': '서쪽 (결실과 정리)',
            'vibe': '미니멀리즘, 세련됨, 차가움, 효율',
            'spot': [
                '여의도 더현대/IFC몰 (메탈릭 감성) 🏢',
                '인천 송도 센트럴파크 🏙️',
                '미니멀한 인테리어의 갤러리 🖼️',
                '금속 공예 클래스 💍',
                '바위가 많은 산 정상 (관악산 등) ⛰️',
                '아이패드 들고 가기 좋은, 테이블 간격 넓은 카페 💻',
                '서점의 자기계발/비즈니스 코너 📊',
                '명품관/편집숍 (살 마음 없이 디자인만 구경) 👜',
                '인테리어 소품숍 (메탈/유리 소재 위주) 🪟',
                '정리 잘 된 문구점 (펜/노트 비교하기) ✒️',
                '공유 오피스 라운지 (2시간 집중 타임) 🗂️',
            ],
            'desc': [
                '무딘 칼날을 전설의 명검으로 갈아줄 **냉철한 통찰력**이 필요한 시기입니다.',
                '지금 필요한 건 위로가 아니라 **폴더 정리**입니다. 일·관계·감정도 폴더별로 나눌 때가 됐어요.',
                '금 기운은 ‘냉정한 나’를 불러옵니다. 감정은 잠깐 옆에 두고, **증거와 기록**만 보고 판단해보세요.',
            ],
            'mission': [
                '서재나 스마트폰 앱 폴더를 칼같이 정리하세요. 금속 시계/반지가 당신의 무기입니다.',
                '휴대폰에서 **앱 5개만 지우기**. 그 정도면 이미 운 정리 시작입니다.',
                '가장 자주 쓰는 가방을 뒤집어서 **영수증/쓰레기**를 한 번 비우세요.',
                '메일함/카톡방에서 ‘안 봐도 되는 채팅방’ 3개만 나와보기.',
            ],
            'avoid': '잡동사니가 널브러진 시장통이나 정리 안 된 내 방 (판단력 흐림) 🚫',
        },

        '수': {
            'direction': '북쪽 (지혜와 휴식)',
            'vibe': '심연, 고요함, 유연함, 딥토크',
            'spot': [
                '한강뷰가 보이는 심야 카페 🌉',
                '비 오는 날의 호텔 로비 ☔',
                '아쿠아리움이나 대형 수족관 🐠',
                '조용한 위스키 바 (혼술 추천) 🥃',
                '반신욕이 가능한 스파/사우나 🛁',
                '밤 11시 이후 조용한 카페 구석자리 ☕',
                '비 오는 날, 우산 없이 걸을 수 있는 지하상가/아케이드 ☔',
                '사람 적은 공원 호수/분수대 앞 🌊',
                '대형 서점의 의자 있는 뷰 포인트 🪑',
                '지하철 맨 끝칸 (창밖 보며 멍 때리기) 🚇',
                'ASMR 틀어주는 힐링 라운지 💤',
            ],
            'desc': [
                '과열된 엔진을 식혀줄 **깊은 바다의 유연함**이 정답입니다. 흐르는 대로 두세요.',
                '수 기운이 약해지면, 생각은 많은데 **감정 배수구가 막힌 상태**가 됩니다. 흘려보내는 연습이 필요합니다.',
                '지금은 답을 내는 시간보다 **‘잠깐 멈춰 있는 시간’을 허락해줘야 하는 시즌**입니다.',
            ],
            'mission': [
                '모든 알림을 끄고 물소리(ASMR 포함)를 들으며 멍때리는 시간을 가지세요.',
                '오늘 하루만은 **‘읽지 않음’ 뱃지**를 조금만 쌓이게 두세요. 즉답 말고, 늦은 답장도 괜찮습니다.',
                '샤워할 때, 평소보다 1분만 더 물을 틀어두고, 그동안 **아무 생각 안 하기** 챌린지.',
                '잠들기 30분 전에는 화면 대신 **물 관련 사운드(파도·비·분수)**만 틀어두기.',
            ],
            'avoid': '소음이 심한 공사장이나 건조하고 뜨거운 사막 같은 곳 (멘탈 바사삭) 🚫',
        },
    }

    target = data.get(weakest_element, data['토'])
    
    # [FIX] 시드 적용: seed_key가 있으면 고정된 결과를, 없으면 랜덤 결과를 반환
    # Python의 random 모듈은 seed 값을 설정하면 항상 동일한 순서로 난수를 생성합니다.
    rng = random.Random(_get_seed(weakest_element, seed_key))
    
    # 랜덤 샘플링 (중복 없이 2개 뽑기)
    selected_spots = rng.sample(target['spot'], 2)
    spot_text = f"{selected_spots[0]} <br>또는<br> {selected_spots[1]}"
    
    # 설명과 미션도 하나씩 뽑기
    # 데이터가 리스트인지 확인하는 안전장치는 그대로 유지
    selected_desc = rng.choice(target['desc']) if isinstance(target['desc'], list) else target['desc']
    selected_mission = rng.choice(target['mission']) if isinstance(target['mission'], list) else target['mission']

    return {
        'direction': target['direction'],
        'spot': spot_text,
        'desc': selected_desc,
        'mission': selected_mission,
        'avoid': target['avoid'],
        'vibe': target['vibe']
    }


def get_lucky_features(weakest_element, seed_key=None):
    """
    부족한 오행을 채워주는 럭키 아이템 (Ultimate Edition).
    seed_key가 있으면 항상 같은 아이템을 추천함.
    """
    
    data_pool = {
        '목': {
            'colors': [
                '네온 그린 🌲', '딥 포레스트 🌿', '라임 옐로우 🍋', '민트 🍃', '카키 🌵',
                '세이지 그린 🌱', '올리브 그린 🫒', '파스텔 민트 🧊', '스프링 라임 💚'
            ],
            'items': [
                '우드 폰케이스', '몬스테라 화분', '새 다이어리', '나무 향수', '종이책',
                '리필 가능한 플래너', '패브릭 포스터(숲)', '초록색 키링', '반투명 텀블러', '재생지 노트'
            ],
            'foods': [
                '그릭 요거트', '바질 파스타', '라임 모히또', '샐러드 볼', '샤인머스캣',
                '아보카도 샌드위치', '케일 스무디', '녹차 라떼', '매실 에이드', '오이 워터'
            ],
            'numbers': [
                '3, 8', '1, 6 (수생목)', '3, 8 (본인 숫자)', 
                '3, 8이 들어간 비번', '계단 3층 단위로 걷기'
            ]
        },

        '화': {
            'colors': [
                '비비드 레드 🔥', '핫 핑크 💖', '선셋 오렌지 🌅', '바이올렛 💜', '버건디 🍷',
                '형광 코랄 🧨', '매트 레드 🍎', '선명한 오렌지 📌', '라즈베리 핑크 🍓'
            ],
            'items': [
                '화려한 조명', '레드 립스틱', '선글라스', '캔들/디퓨저', '카메라',
                '네온 폰케이스', '글리터 아이템', '미니 무드등', '피크닉 스피커', '레터링 티셔츠'
            ],
            'foods': [
                '아아(얼죽아)', '마라탕', '레드 와인', '다크 초콜릿', '매운 떡볶이',
                '스파이시 치킨', '칠리 프라이', '레드벨벳 케이크', '김치볶음밥', '토마토 리조또'
            ],
            'numbers': [
                '2, 7', '3, 8 (목생화)', '2, 7 (본인 숫자)', 
                '2, 7이 겹치는 시간에 약속 잡기', '알람을 22분, 27분에 맞추기'
            ]
        },

        '토': {
            'colors': [
                '샌드 베이지 🏜️', '머스타드 🥨', '테라코타 🧱', '웜 브라운 🐻', '크림 화이트 ☁️',
                '라떼 베이지 ☕', '오트밀 크림 🥛', '브론즈 브라운 🧸', '모카 브라운 🧋'
            ],
            'items': [
                '도자기 머그', '포근한 담요', '가죽 지갑', '원석 팔찌', '캠핑 의자',
                '폭신한 슬리퍼', '바디필로우', '니트 쿠션', '두꺼운 노트', '라탄 바구니'
            ],
            'foods': [
                '치즈 케이크', '베이글', '단호박 스프', '밀크티', '고구마 라떼',
                '버터 쿠키', '콘 스프', '카푸치노', '소금빵', '감자 구이'
            ],
            'numbers': [
                '5, 0', '2, 7 (화생토)', '5, 0 (본인 숫자)', 
                '5일, 10일, 25일에 루틴 시작하기', '좌석 번호 5의 배수 고르기'
            ]
        },

        '금': {
            'colors': [
                '메탈릭 실버 💍', '퓨어 화이트 🤍', '크롬 골드 🏆', '차콜 그레이 🔘', '미러볼 🪩',
                '실버 블루 🫧', '스톤 그레이 🪨', '스틸 블루 🛠️', '티타늄 그레이 ⚙️'
            ],
            'items': [
                '메탈 안경', '실버 링', '스마트 워치', '만년필', '미니멀 거울',
                '메탈 볼펜', '카드지갑', '이어커프', '스테인리스 텀블러', '북엔드'
            ],
            'foods': [
                '평양냉면', '제로 콜라', '화이트 와인', '닭가슴살', '민트 초코',
                '탄산수', '콜드브루', '연어 사시미', '담백한 머핀', '프로틴 쉐이크'
            ],
            'numbers': [
                '4, 9', '5, 0 (토생금)', '4, 9 (본인 숫자)', 
                '4로 끝나는 좌석에 앉기', '회의는 4분, 9분에 시작해보기'
            ]
        },

        '수': {
            'colors': [
                '미드나잇 블루 🌊', '제트 블랙 🖤', '차콜 네이비 🌌', '투명 클리어 💎', '딥 퍼플 🔮',
                '인디고 블루 🧿', '스모키 퍼플 🌌', '잉크 블랙 🖋️', '다크 네이비 ⚓'
            ],
            'items': [
                '투명 케이스', '어항 소품', '스피커', '수면 안대', '바스밤',
                '노이즈 캔슬링 이어폰', '무드등(블루)', '아로마 오일', '다크 후디', '유리컵'
            ],
            'foods': [
                '하이볼', '조개구이', '프레첼', '물냉면', '아이스크림',
                '따뜻한 허브티', '카모마일', '젤라또', '생선구이', '우롱차'
            ],
            'numbers': [
                '1, 6', '4, 9 (금생수)', '1, 6 (본인 숫자)', 
                '밤 11:16(1116)에 하루 정리하기', '1, 6이 들어간 층에서 쉬기'
            ]
        },
    }

    target = data_pool.get(weakest_element, data_pool['토'])
    
    # [FIX] 시드 적용
    rng = random.Random(_get_seed(weakest_element, seed_key))

    return {
        'color': rng.choice(target['colors']),
        'number': rng.choice(target['numbers']),
        'item': rng.choice(target['items']),
        'food': rng.choice(target['foods']),
    }